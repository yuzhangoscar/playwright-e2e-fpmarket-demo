services:
  # Playwright E2E Tests Service
  e2e-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.e2e
    volumes:
      - ./test-results-e2e:/app/test-results
      - ./playwright-report:/app/playwright-report
      - ./allure-results:/app/allure-results
      - ./allure-report:/app/allure-report
    environment:
      - CI=true
      - BASE_URL=${BASE_URL:-https://crypto.com/exchange/trade/BTC_USD}
      - TEST_TIMEOUT=${TEST_TIMEOUT:-30000}
      - HEADLESS=${HEADLESS:-true}
    networks:
      - test-network

  # Jest API Tests Service
  api-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    volumes:
      - ./allure-results-api:/app/allure-results-api
      - ./coverage-api:/app/coverage-api
    environment:
      - NODE_ENV=test
      - CI=true
      - API_PORT=3000
    networks:
      - test-network

  # WCAG Accessibility Tests Service
  wcag-tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.wcag
    volumes:
      - ./test-results-wcag:/app/test-results
      - ./accessibility-report:/app/accessibility-report
      - ./accessibility-results.json:/app/accessibility-results.json
      - ./accessibility-results.xml:/app/accessibility-results.xml
    environment:
      - CI=true
      - BASE_URL=${BASE_URL:-https://crypto.com/exchange/trade/BTC_USD}
      - TEST_TIMEOUT=${TEST_TIMEOUT:-60000}
      - HEADLESS=${HEADLESS:-true}
    networks:
      - test-network

  # API Server (for testing)
  api-server:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    command: ['npm', 'run', 'api:start']
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - PORT=3000
    networks:
      - test-network

  # E2E Allure Report Server
  e2e-allure-server:
    image: nginx:alpine
    volumes:
      - ./allure-report:/usr/share/nginx/html:ro
    ports:
      - '9001:80'
    depends_on:
      - e2e-tests
    networks:
      - test-network

  # API Allure Report Server
  api-allure-server:
    image: nginx:alpine
    volumes:
      - ./allure-report-api:/usr/share/nginx/html:ro
    ports:
      - '9002:80'
    depends_on:
      - api-tests
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
