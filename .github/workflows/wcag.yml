name: WCAG Accessibility Tests via Docker

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      env:
        description: 'choose ENV, it could be dev, staging or prod'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read

jobs:
  wcag-docker-tests:
    name: WCAG Accessibility Tests via Docker
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment for WCAG tests
        run: |
          # Create directories for WCAG test results
          mkdir -p test-results-wcag accessibility-report

      - name: Build WCAG Docker image
        run: |
          echo "ðŸ³ Building WCAG Docker image..."
          docker build -f docker/Dockerfile.wcag -t wcag-tests .

      - name: Run WCAG tests in Docker
        run: |
          echo "â™¿ Running WCAG accessibility tests in Docker container..."

          # Run WCAG tests with volume mounts for results
          docker run --rm \
            -v $(pwd)/test-results-wcag:/app/test-results \
            -v $(pwd)/accessibility-report:/app/accessibility-report \
            -e CI=true \
            -e BASE_URL=https://crypto.com/exchange/trade/BTC_USD \
            -e TEST_TIMEOUT=60000 \
            -e HEADLESS=true \
            wcag-tests

      - name: Upload WCAG test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wcag-test-results-${{ github.event.number || github.run_number }}
          path: |
            test-results-wcag/
            accessibility-report/
            accessibility-results.json
            accessibility-results.xml
          retention-days: 7

      - name: Generate WCAG test summary
        if: always()
        run: |
          echo "## â™¿ WCAG Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "test-results-wcag" ] && [ "$(ls -A test-results-wcag 2>/dev/null)" ]; then
            echo "### âœ… WCAG Tests Completed" >> $GITHUB_STEP_SUMMARY
            echo "WCAG accessibility tests have been executed via Docker container." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count test files
            TEST_COUNT=$(find test-results-wcag -name "*.xml" -o -name "*.json" 2>/dev/null | wc -l)
            echo "- ðŸ“ **Result Files Generated:** $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
            
            # Check for accessibility violations
            if [ -f "accessibility-results.json" ]; then
              echo "- â™¿ **Accessibility Report:** Generated in \`accessibility-results.json\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -d "accessibility-report" ]; then
              echo "- ðŸ“Š **HTML Report:** Available in \`accessibility-report/\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check for screenshots/videos (indicates test execution)
            SCREENSHOT_COUNT=$(find test-results-wcag -name "*.png" -o -name "*.webm" 2>/dev/null | wc -l)
            if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
              echo "- ðŸ“¸ **Screenshots/Videos:** $SCREENSHOT_COUNT (test evidence captured)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ WCAG Test Timeout or Issues" >> $GITHUB_STEP_SUMMARY
            echo "WCAG tests may have timed out (2min limit) or failed to generate results." >> $GITHUB_STEP_SUMMARY
            echo "Consider running locally with \`make test-accessibility\` for detailed analysis." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Reports Available" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`wcag-test-results-${{ github.event.number || github.run_number }}\` artifact to view:" >> $GITHUB_STEP_SUMMARY
          echo "- **Accessibility Report:** Open \`accessibility-report/index.html\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Results:** Raw accessibility test data in \`test-results-wcag/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON/XML Reports:** Detailed violation data in \`accessibility-results.*\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â™¿ Tests Executed" >> $GITHUB_STEP_SUMMARY
          echo "- **WCAG Compliance Tests:** WCAG 2.1 AA/AAA and 2.2 Level standards" >> $GITHUB_STEP_SUMMARY
          echo "- **Browser:** Chromium in Docker container" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Headless mode with axe-core accessibility scanning" >> $GITHUB_STEP_SUMMARY
          echo "- **Timeout:** 2-minute limit for quick feedback in CI/CD pipeline" >> $GITHUB_STEP_SUMMARY
