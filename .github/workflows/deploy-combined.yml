name: Deploy Combined Reports to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      env:
        description: 'choose ENV, it could be dev, staging or prod'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: 'combined-pages'
  cancel-in-progress: false

jobs:
  generate-and-deploy-reports:
    name: Generate E2E & WCAG Reports, Deploy to GitHub Pages
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Create report directories
        run: |
          mkdir -p test-results playwright-report allure-results allure-report accessibility-report combined-reports

      - name: Build E2E Docker image
        run: |
          echo "üê≥ Building E2E Docker image..."
          docker build -f docker/Dockerfile.e2e -t e2e-tests .

      - name: Run E2E tests in Docker for Allure report
        run: |
          echo "üé≠ Running E2E tests in Docker container to generate Allure reports..."

          # Set the test command for Allure report generation
          TEST_CMD="npm run test:allure && npm run allure:generate"

          # Run E2E tests with volume mounts for all results and reports
          docker run --rm \
            -v $(pwd)/test-results:/app/test-results \
            -v $(pwd)/playwright-report:/app/playwright-report \
            -v $(pwd)/allure-results:/app/allure-results \
            -v $(pwd)/allure-report:/app/allure-report \
            -e CI=true \
            -e BASE_URL=${{ github.event.inputs.env == 'prod' && 'https://crypto.com/exchange/trade/BTC_USD' || github.event.inputs.env == 'staging' && 'https://crypto.com/exchange/trade/BTC_USD' || 'https://crypto.com/exchange/trade/BTC_USD' }} \
            -e TEST_TIMEOUT=60000 \
            -e HEADLESS=true \
            e2e-tests \
            sh -c "$TEST_CMD"

      - name: Run WCAG accessibility tests
        continue-on-error: true
        run: |
          echo "‚ôø Running WCAG accessibility tests..."
          npm run test:wcag:report || {
            echo "‚ö†Ô∏è WCAG tests failed, but continuing deployment..."
            echo "Creating placeholder accessibility report..."
            mkdir -p accessibility-report
            cp .github/templates/wcag-failed.html accessibility-report/index.html
            exit 0
          }
        env:
          CI: true
          BASE_URL: ${{ github.event.inputs.env == 'prod' && 'https://crypto.com/exchange/trade/BTC_USD' || github.event.inputs.env == 'staging' && 'https://crypto.com/exchange/trade/BTC_USD' || 'https://crypto.com/exchange/trade/BTC_USD' }}
          HEADLESS: true

      - name: Create combined reports structure
        run: |
          echo "üìÅ Creating combined reports structure..."
          # Copy main index template
          cp .github/templates/main-index.html combined-reports/index.html

      - name: Copy reports to combined structure
        run: |
          echo "üìã Organizing reports..."

          # Copy Allure report
          if [ -d "allure-report" ] && [ -f "allure-report/index.html" ]; then
            cp -r allure-report combined-reports/allure
            echo "‚úÖ Allure report copied"
          else
            echo "‚ö†Ô∏è Allure report not found, creating placeholder"
            mkdir -p combined-reports/allure
            echo "<h1>Allure Report Not Available</h1><p>E2E tests may have failed or not generated reports.</p>" > combined-reports/allure/index.html
          fi

          # Copy WCAG report and create enhanced index with PNG gallery
          if [ -d "accessibility-report" ] && [ -f "accessibility-report/index.html" ]; then
            cp -r accessibility-report combined-reports/wcag
            echo "‚úÖ WCAG report copied"
            
            # Move original report to data subdirectory and use enhanced gallery as main page
            echo "üì∏ Creating enhanced WCAG report with PNG gallery..."
            mkdir -p combined-reports/wcag/data
            mv combined-reports/wcag/index.html combined-reports/wcag/data/
            cp .github/templates/wcag-gallery.html combined-reports/wcag/index.html
            
            # Generate screenshots manifest for the gallery
            echo "üìã Generating screenshots manifest..."
            echo "{" > combined-reports/wcag/screenshots-manifest.json
            echo '  "generated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",' >> combined-reports/wcag/screenshots-manifest.json
            echo '  "screenshots": [' >> combined-reports/wcag/screenshots-manifest.json
            
            # Find all PNG files in accessibility-report and test-results
            SCREENSHOT_FILES=""
            for dir in accessibility-report test-results; do
              if [ -d "$dir" ]; then
                for png_file in $(find "$dir" -name "*.png" -type f 2>/dev/null); do
                  # Preserve directory structure to avoid filename collisions
                  # Instead of stripping first directory, use full relative path with source prefix
                  source_prefix=$(basename "$dir")
                  relative_path_in_source=$(echo "$png_file" | sed "s|^$dir/||")
                  final_path="$source_prefix/$relative_path_in_source"
                  
                  # Create parent directories before copying
                  target_dir="combined-reports/wcag/$(dirname "$final_path")"
                  mkdir -p "$target_dir"
                  
                  # Copy PNG to wcag directory with preserved structure
                  if cp "$png_file" "combined-reports/wcag/$final_path" 2>/dev/null; then
                    echo "‚úÖ Copied: $png_file -> $final_path"
                    if [ -n "$SCREENSHOT_FILES" ]; then
                      SCREENSHOT_FILES="$SCREENSHOT_FILES,"
                    fi
                    SCREENSHOT_FILES="$SCREENSHOT_FILES    \"./$final_path\""
                  else
                    echo "‚ùå Failed to copy: $png_file"
                  fi
                done
              fi
            done
            
            echo "$SCREENSHOT_FILES" >> combined-reports/wcag/screenshots-manifest.json
            echo '  ]' >> combined-reports/wcag/screenshots-manifest.json
            echo '}' >> combined-reports/wcag/screenshots-manifest.json
            
            # Show manifest content for debugging
            echo "üìã Screenshots manifest generated:"
            cat combined-reports/wcag/screenshots-manifest.json
            
          else
            echo "‚ö†Ô∏è WCAG report not found, creating placeholder"
            mkdir -p combined-reports/wcag
            cp .github/templates/wcag-failed.html combined-reports/wcag/index.html
            
            # Create empty manifest for failed tests
            echo '{"generated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "screenshots": []}' > combined-reports/wcag/screenshots-manifest.json
          fi

      - name: Update main page with metadata
        run: |
          echo "üîÑ Adding metadata to main page..."

          # Update placeholders in index.html
          ENV_VALUE="${{ github.event.inputs.env || 'dev' }}"
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT=${COMMIT_SHORT:0:7}
          WORKFLOW_EVENT="${{ github.event_name }}"

          sed -i "s/ENVIRONMENT_PLACEHOLDER/$ENV_VALUE/g" combined-reports/index.html
          sed -i "s/COMMIT_PLACEHOLDER/$COMMIT_SHORT/g" combined-reports/index.html
          sed -i "s/WORKFLOW_PLACEHOLDER/$WORKFLOW_EVENT/g" combined-reports/index.html

      - name: Verify combined reports
        run: |
          echo "üîç Verifying combined reports structure..."
          find combined-reports -type f -name "*.html" | head -10

          ls -la combined-reports/
          echo "Main page exists:" $([ -f "combined-reports/index.html" ] && echo "‚úÖ" || echo "‚ùå")
          echo "Allure report exists:" $([ -f "combined-reports/allure/index.html" ] && echo "‚úÖ" || echo "‚ùå")
          echo "WCAG report exists:" $([ -f "combined-reports/wcag/index.html" ] && echo "‚úÖ" || echo "‚ùå")

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload combined reports to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./combined-reports

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: combined-test-results-${{ github.run_number }}
          path: |
            combined-reports/
            test-results/
            playwright-report/
            allure-results/
            accessibility-results.json
            accessibility-results.xml
          retention-days: 7

      - name: Generate deployment summary
        if: always()
        run: |
          echo "## üé≠ Combined Test Reports Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.deployment.outcome }}" == "success" ]; then
            echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "Combined test reports have been successfully deployed to GitHub Pages!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**üåê Main Report Hub:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
            echo "**üìä Allure Reports:** ${{ steps.deployment.outputs.page_url }}allure/" >> $GITHUB_STEP_SUMMARY
            echo "**‚ôø WCAG Reports:** ${{ steps.deployment.outputs.page_url }}wcag/" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã Report Contents" >> $GITHUB_STEP_SUMMARY
            echo "#### Allure Report Features:" >> $GITHUB_STEP_SUMMARY
            echo "- **Test Execution History:** Detailed test run timeline" >> $GITHUB_STEP_SUMMARY
            echo "- **Trends & Analytics:** Historical success/failure patterns" >> $GITHUB_STEP_SUMMARY
            echo "- **Screenshots & Videos:** Visual evidence of test execution" >> $GITHUB_STEP_SUMMARY
            echo "- **Step-by-Step Details:** Granular test execution breakdown" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### WCAG Accessibility Features:" >> $GITHUB_STEP_SUMMARY
            echo "- **WCAG 2.1 Compliance:** AA/AAA level accessibility testing" >> $GITHUB_STEP_SUMMARY
            echo "- **Violation Details:** Specific accessibility issues found" >> $GITHUB_STEP_SUMMARY
            echo "- **Remediation Guide:** Actionable fixes for each violation" >> $GITHUB_STEP_SUMMARY
            echo "- **Visual Evidence:** Screenshots of accessibility problems" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "There was an issue deploying the combined reports to GitHub Pages." >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîÑ Execution Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "- **Trigger:** Push to main branch (PR merged)" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Trigger:** Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
            echo "- **Environment:** ${{ github.event.inputs.env || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- **E2E Tests:** Docker containerized execution" >> $GITHUB_STEP_SUMMARY
          echo "- **WCAG Tests:** Native Playwright with accessibility focus" >> $GITHUB_STEP_SUMMARY
          echo "- **Browsers:** Chromium, Firefox (E2E) + Chromium (WCAG)" >> $GITHUB_STEP_SUMMARY
