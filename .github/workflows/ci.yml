name: E2E Tests via Docker

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Test tag filter (e.g., @smoke, @slow)'
        required: false
        default: ''
        type: string
      env:
        description: 'choose ENV, it could be dev, staging or prod'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: write

jobs:
  e2e-docker-tests:
    name: E2E Tests via Docker (CI)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment file
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "BASE_URL=https://crypto.com/exchange/trade/BTC_USD" > .env
            echo "TEST_TIMEOUT=30000" >> .env
            echo "HEADLESS=true" >> .env
          fi

      - name: Build E2E Docker image
        run: |
          echo "ğŸ³ Building E2E Docker image..."
          docker build -f docker/Dockerfile.e2e -t e2e-tests .

      - name: Run E2E tests in Docker
        run: |
          echo "ğŸ§ª Running E2E tests in Docker container..."

          # Create directories for test results
          mkdir -p test-results playwright-report allure-results allure-report

          # Set test command based on tag input
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "ğŸ·ï¸ Running tests with tag filter: ${{ github.event.inputs.tag }}"
            TEST_CMD="npm run test:allure -- --grep \"${{ github.event.inputs.tag }}\" && npm run allure:generate"
          else
            echo "ğŸ­ Running all E2E tests"
            TEST_CMD="npm run test:allure && npm run allure:generate"
          fi

          # Run E2E tests with volume mounts for results
          docker run --rm \
            -v $(pwd)/test-results:/app/test-results \
            -v $(pwd)/playwright-report:/app/playwright-report \
            -v $(pwd)/allure-results:/app/allure-results \
            -v $(pwd)/allure-report:/app/allure-report \
            -e CI=true \
            -e BASE_URL=https://crypto.com/exchange/trade/BTC_USD \
            -e TEST_TIMEOUT=30000 \
            -e HEADLESS=true \
            e2e-tests \
            sh -c "$TEST_CMD"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.tag && format('e2e-test-results-{0}-{1}', github.event.inputs.tag, github.run_number) || format('e2e-test-results-pr-{0}', github.event.number || github.run_number) }}
          path: |
            test-results/
            playwright-report/
            allure-results/
            allure-report/
          retention-days: 7
