name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    name: Test and generate Allure report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run API server tests
        run: |
          npm run api:build
          npm run api:test

      - name: Run E2E tests and generate Allure results
        run: |
          npx playwright install --with-deps
          npx playwright test || exit 0

      - name: Set up Java for Allure CLI
        if: always()
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Allure CLI
        if: always()
        uses: actions/cache@v4
        id: allure-cache
        with:
          path: /opt/allure
          key: allure-2.25.0

      - name: Install Allure CLI
        if: always() && steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          curl -o allure-commandline.zip -Ls https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.zip
          unzip -q allure-commandline.zip
          sudo mv allure-2.25.0 /opt/allure

      - name: Setup Allure CLI PATH
        if: always()
        run: |
          sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      - name: Generate Allure HTML report
        if: always()
        run: |
          allure generate ./allure-results -o ./allure-report --clean

      - name: Upload Allure HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-pr-${{ github.event.number }}
          path: ./allure-report

  deploy:
    name: Deploy Allure report to GitHub Pages
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run API server tests
        run: |
          npm run api:build
          npm run api:test

      - name: Run E2E tests and generate Allure results
        run: |
          npx playwright install --with-deps
          npx playwright test || exit 0

      - name: Set up Java for Allure CLI
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Allure CLI
        uses: actions/cache@v4
        id: allure-cache
        with:
          path: /opt/allure
          key: allure-2.25.0

      - name: Install Allure CLI
        if: steps.allure-cache.outputs.cache-hit != 'true'
        run: |
          curl -o allure-commandline.zip -Ls https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.zip
          unzip -q allure-commandline.zip
          sudo mv allure-2.25.0 /opt/allure

      - name: Setup Allure CLI PATH
        run: |
          sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      - name: Generate Allure HTML report
        run: |
          allure generate ./allure-results -o ./allure-report --clean

      - name: Create Reports Index
        run: |
          mkdir -p ./allure-report-with-index/allure-reports
          cp -r ./allure-report ./allure-report-with-index/allure-reports/${{ github.run_number }}
          
          cat > ./allure-report-with-index/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Playwright E2E Test Reports</title>
              <meta charset="UTF-8">
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
                  .report-link { display: block; padding: 15px; margin: 10px 0; background: #007acc; color: white; text-decoration: none; border-radius: 5px; transition: background 0.3s; }
                  .report-link:hover { background: #005a9e; }
                  .latest { background: #28a745; }
                  .latest:hover { background: #218838; }
                  .meta { color: #666; font-size: 14px; margin-top: 5px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üß™ Playwright E2E Test Reports</h1>
                  <p>Comprehensive test results with Allure reporting</p>
                  
                  <a href="./allure-reports/${{ github.run_number }}/" class="report-link latest">
                      üìä Latest Report (Run #${{ github.run_number }})
                      <div class="meta">Generated: $(date)</div>
                  </a>
                  
                  <h3>üìÅ All Reports</h3>
                  <p>Reports are organized by GitHub Actions run number.</p>
                  
                  <h3>üîó Direct Access</h3>
                  <p>Replace <code>[RUN_NUMBER]</code> with the specific run number:</p>
                  <code>https://yuzhangoscar.github.io/playwright-e2e-fpmarket-demo/allure-reports/[RUN_NUMBER]/</code>
              </div>
          </body>
          </html>
          EOF

      - name: Create .nojekyll file
        run: |
          touch ./allure-report-with-index/.nojekyll

      - name: Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report-with-index
          keep_files: true

      - name: Output Allure Report URL
        run: |
          echo "## üìä Allure Report Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Report URL:** https://yuzhangoscar.github.io/playwright-e2e-fpmarket-demo/allure-reports/${{ github.run_number }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÅ **Browse All Reports:** https://yuzhangoscar.github.io/playwright-e2e-fpmarket-demo/" >> $GITHUB_STEP_SUMMARY

      - name: Deploy API Server to AWS EC2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$EC2_HOST" ] || [ -z "$EC2_SSH_KEY" ]; then
            echo "‚ö†Ô∏è AWS deployment skipped: Missing required secrets"
            echo "Required: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, EC2_HOST, EC2_SSH_KEY"
            exit 0
          fi
          
          # Install AWS CLI if not present
          if ! command -v aws &> /dev/null; then
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
          fi
          
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          
          # Deploy using deployment script
          chmod +x ./deployment/deploy.sh
          ./deployment/deploy.sh "$EC2_HOST" ~/.ssh/ec2_key.pem main
          
          # Output deployment info
          echo "## üöÄ API Server Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Health Check:** http://$EC2_HOST:3000/api/health" >> $GITHUB_STEP_SUMMARY
          echo "üìã **Blacklist API:** http://$EC2_HOST:3000/api/blacklist" >> $GITHUB_STEP_SUMMARY
          echo "üîç **Check Name:** http://$EC2_HOST:3000/api/blacklist/check/malicious_user" >> $GITHUB_STEP_SUMMARY