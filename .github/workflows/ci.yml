name: E2E Tests via Docker

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Test tag filter (e.g., @smoke, @slow)'
        required: false
        default: ''
        type: string

permissions:
  contents: read

jobs:
  e2e-docker-tests:
    name: E2E Tests via Docker
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment file
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "BASE_URL=https://crypto.com/exchange/trade/BTC_USD" > .env
            echo "TEST_TIMEOUT=30000" >> .env
            echo "HEADLESS=true" >> .env
          fi

      - name: Build E2E Docker image
        run: |
          echo "ðŸ³ Building E2E Docker image..."
          docker build -f docker/Dockerfile.e2e -t e2e-tests .

      - name: Run E2E tests in Docker
        run: |
          echo "ðŸ§ª Running E2E tests in Docker container..."
          
          # Create directories for test results
          mkdir -p test-results playwright-report allure-results
          
          # Set test command based on tag input
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "ðŸ·ï¸ Running tests with tag filter: ${{ github.event.inputs.tag }}"
            TEST_CMD="npm test -- --grep \"${{ github.event.inputs.tag }}\""
          else
            echo "ðŸŽ­ Running all E2E tests"
            TEST_CMD="npm test"
          fi
          
          # Run E2E tests with volume mounts for results
          docker run --rm \
            -v $(pwd)/test-results:/app/test-results \
            -v $(pwd)/playwright-report:/app/playwright-report \
            -v $(pwd)/allure-results:/app/allure-results \
            -e CI=true \
            -e BASE_URL=https://crypto.com/exchange/trade/BTC_USD \
            -e TEST_TIMEOUT=30000 \
            -e HEADLESS=true \
            e2e-tests \
            sh -c "$TEST_CMD"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.tag && format('e2e-test-results-{0}-{1}', github.event.inputs.tag, github.run_number) || format('e2e-test-results-pr-{0}', github.event.number || github.run_number) }}
          path: |
            test-results/
            playwright-report/
            allure-results/
          retention-days: 7

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show tag information if provided
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "### ðŸ·ï¸ Tag Filter Applied" >> $GITHUB_STEP_SUMMARY
            echo "**Filter:** \`${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check if test results exist
          if [ -d "test-results" ] && [ "$(ls -A test-results)" ]; then
            echo "### âœ… Test Execution Completed" >> $GITHUB_STEP_SUMMARY
            echo "E2E tests have been executed via Docker container." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Count test files
            TEST_COUNT=$(find test-results -name "*.xml" -o -name "*.json" | wc -l)
            echo "- ðŸ“ **Result Files Generated:** $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
            
            # Check for screenshots/videos (indicates failures)
            SCREENSHOT_COUNT=$(find test-results -name "*.png" -o -name "*.webm" | wc -l)
            if [ "$SCREENSHOT_COUNT" -gt 0 ]; then
              echo "- ðŸ“¸ **Screenshots/Videos:** $SCREENSHOT_COUNT (failures detected)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… **No failure artifacts found**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ No Test Results Found" >> $GITHUB_STEP_SUMMARY
            echo "Tests may have failed to run or generate results." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Reports Available" >> $GITHUB_STEP_SUMMARY
          ARTIFACT_NAME="${{ github.event.inputs.tag && format('e2e-test-results-{0}-{1}', github.event.inputs.tag, github.run_number) || format('e2e-test-results-pr-{0}', github.event.number || github.run_number) }}"
          echo "Download the \`$ARTIFACT_NAME\` artifact to view:" >> $GITHUB_STEP_SUMMARY
          echo "- **Playwright HTML Report:** Open \`playwright-report/index.html\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Results:** Raw test execution data in \`test-results/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Allure Results:** For Allure report generation in \`allure-results/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ­ Tests Executed" >> $GITHUB_STEP_SUMMARY
          echo "- **E2E Navigation Tests:** Crypto trading platform functionality" >> $GITHUB_STEP_SUMMARY
          echo "- **Browser:** Chromium in Docker container" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Headless mode with consistent Docker runtime" >> $GITHUB_STEP_SUMMARY
